{
  "Comment": "State machine that deactivates all active user AccessKeys that are more than 7 days old",
  "StartAt": "ListUsers",
  "TimeoutSeconds": 60,
  "States": {
    "ListUsers": {
      "Type": "Task",
      "Parameters": {},
      "Resource": "arn:aws:states:::aws-sdk:iam:listUsers",
      "Next": "Map"
    },
    "Map": {
      "Type": "Map",
      "Iterator": {
        "StartAt": "ListAccessKeys",
        "States": {
          "ListAccessKeys": {
            "Type": "Task",
            "Parameters": {
              "UserName.$": "$.UserName"
            },
            "Resource": "arn:aws:states:::aws-sdk:iam:listAccessKeys",
            "ResultPath": "$",
            "Next": "For each AccessKey"
          },
          "For each AccessKey": {
            "Type": "Map",
            "ItemsPath": "$.AccessKeyMetadata",
            "End": true,
            "Iterator": {
              "StartAt": "Get AccessKey expiration date",
              "States": {
                "Get AccessKey expiration date": {
                  "Type": "Task",
                  "Resource": "${StatesDateTimeAddFunctionArn}",
                  "Parameters": {
                    "Value.$": "$.CreateDate",
                    "Step": 7,
                    "Unit": "Days"
                  },
                  "Next": "Get AccessKey expiration warning window",
                  "ResultPath": "$.ExpiryDate"
                },
                "Get AccessKey expiration warning window": {
                  "Type": "Parallel",
                  "Branches": [{
                    "StartAt": "Get AccessKey expiration warning lower bound",
                    "States": {
                      "Get AccessKey expiration warning lower bound": {
                        "Type": "Task",
                        "Resource": "${StatesDateTimeAddFunctionArn}",
                        "Parameters": {
                          "Value.$": "$.ExpiryDate",
                          "Step": -86695,
                          "Unit": "Seconds"
                        },
                        "ResultPath": "$",
                        "End": true
                      }
                    }
                  },
                    {
                      "StartAt": "Get AccessKey expiration warning upper bound",
                      "States": {
                        "Get AccessKey expiration warning upper bound": {
                          "Type": "Task",
                          "Resource": "${StatesDateTimeAddFunctionArn}",
                          "Parameters": {
                            "Value.$": "$.ExpiryDate",
                            "Step": -86105,
                            "Unit": "Seconds"
                          },
                          "ResultPath": "$",
                          "End": true
                        }
                      }
                    }
                  ],
                  "ResultPath": "$.ExpiryWarning",
                  "ResultSelector": {
                    "LowerBound.$": "$[0]",
                    "UpperBound.$": "$[1]"
                  },
                  "Next": "Check Dates"
                },
                "Check Dates": {
                  "Type": "Choice",
                  "Choices": [{
                    "And": [{
                      "Variable": "$.ExpiryWarning.LowerBound",
                      "TimestampLessThanEqualsPath": "$$.Execution.StartTime"
                    },
                      {
                        "Variable": "$.ExpiryWarning.UpperBound",
                        "TimestampGreaterThanEqualsPath": "$$.Execution.StartTime"
                      },
                      {
                        "Variable": "$.Status",
                        "StringEquals": "Active"
                      }
                    ],
                    "Next": "Send warning notification"
                  },
                    {
                      "And": [{
                        "Variable": "$.ExpiryDate",
                        "TimestampLessThanEqualsPath": "$$.Execution.StartTime"
                      },
                        {
                          "Variable": "$.Status",
                          "StringEquals": "Active"
                        }
                      ],
                      "Next": "UpdateAccessKey"
                    }
                  ],
                  "Default": "Check Dates finish"
                },
                "UpdateAccessKey": {
                  "Type": "Task",
                  "End": true,
                  "Parameters": {
                    "AccessKeyId.$": "$.AccessKeyId",
                    "UserName.$": "$.UserName",
                    "Status": "Inactive"
                  },
                  "Resource": "arn:aws:states:::aws-sdk:iam:updateAccessKey",
                  "ResultPath": null
                },
                "Send warning notification": {
                  "Type": "Task",
                  "Resource": "arn:aws:states:::sns:publish",
                  "Parameters": {
                    "TopicArn": "${DeactivationWarningSnsTopicArn}",
                    "Message.$": "States.Format('User with username {} has an active AccessKey set to expire at {}', $.UserName, $.ExpiryDate)"
                  },
                  "ResultPath": null,
                  "End": true
                },
                "Check Dates finish": {
                  "Type": "Succeed"
                }
              }
            }
          }
        }
      },
      "ItemsPath": "$.Users",
      "ResultPath": null,
      "Next": "Continuation needed?"
    },
    "Continuation needed?": {
      "Type": "Choice",
      "Choices": [{
        "Variable": "$.Marker",
        "IsPresent": true,
        "Next": "Pass"
      }],
      "Default": "No more Users"
    },
    "Pass": {
      "Type": "Pass",
      "Next": "ListUsers (w Marker)",
      "ResultPath": "$",
      "Parameters": {
        "Marker.$": "$.Marker"
      }
    },
    "ListUsers (w Marker)": {
      "Type": "Task",
      "Next": "Map",
      "Parameters": {
        "Marker.$": "$.Marker"
      },
      "Resource": "arn:aws:states:::aws-sdk:iam:listUsers"
    },
    "No more Users": {
      "Type": "Succeed"
    }
  }
}