{
  "Comment": "IAM Access Key expiration state machine",
  "StartAt": "Is this a continuation?",
  "TimeoutSeconds": 60,
  "States": {
    "Is this a continuation?": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.Marker",
          "IsPresent": true,
          "Next": "Set results Marker"
        }
      ],
      "Default": "ListUsers"
    },
    "Set results Marker": {
      "Type": "Pass",
      "Next": "ListUsers (w Marker)",
      "ResultPath": "$",
      "Parameters": {
        "Marker.$": "$.Marker"
      }
    },
    "ListUsers (w Marker)": {
      "Type": "Task",
      "Next": "Parallel",
      "Parameters": {
        "Marker.$": "$.Marker"
      },
      "Resource": "arn:aws:states:::aws-sdk:iam:listUsers"
    },
    "ListUsers": {
      "Type": "Task",
      "Parameters": {},
      "Resource": "arn:aws:states:::aws-sdk:iam:listUsers",
      "Next": "Parallel"
    },
    "Parallel": {
      "Type": "Parallel",
      "Branches": [
        {
          "StartAt": "Has more results?",
          "States": {
            "Has more results?": {
              "Type": "Choice",
              "Choices": [
                {
                  "Variable": "$.IsTruncated",
                  "BooleanEquals": true,
                  "Next": "Step Functions StartExecution"
                }
              ],
              "Default": "Has more results? finish"
            },
            "Has more results? finish": {
              "Type": "Succeed"
            },
            "Step Functions StartExecution": {
              "Type": "Task",
              "Resource": "arn:aws:states:::states:startExecution",
              "Parameters": {
                "StateMachineArn.$": "$$.StateMachine.Id",
                "Input": {
                  "Marker.$": "$.Marker",
                  "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
                }
              },
              "End": true
            }
          }
        },
        {
          "StartAt": "Map",
          "States": {
            "Map": {
              "Type": "Map",
              "Iterator": {
                "StartAt": "ListAccessKeys",
                "States": {
                  "ListAccessKeys": {
                    "Type": "Task",
                    "Parameters": {
                      "UserName.$": "$.UserName"
                    },
                    "Resource": "arn:aws:states:::aws-sdk:iam:listAccessKeys",
                    "ResultPath": "$",
                    "Next": "For each AccessKey"
                  },
                  "For each AccessKey": {
                    "Type": "Map",
                    "ItemsPath": "$.AccessKeyMetadata",
                    "End": true,
                    "Iterator": {
                      "StartAt": "Get AccessKey expiration date",
                      "States": {
                        "Get AccessKey expiration date": {
                          "Type": "Task",
                          "Resource": "${StatesDateTimeAddFunctionArn}",
                          "Parameters": {
                            "Value.$": "$.CreateDate",
                            "Step": ${AccessKeyExpirationTimeInSeconds},
                            "Unit": "Seconds"
                          },
                          "Retry": [
                            {
                              "ErrorEquals": [
                                "Lambda.ServiceException",
                                "Lambda.AWSLambdaException",
                                "Lambda.SdkClientException",
                                "Lambda.TooManyRequestsException"
                              ],
                              "IntervalSeconds": 1,
                              "MaxAttempts": 6,
                              "BackoffRate": 2.0
                            }
                          ],
                          "Next": "Check Dates",
                          "ResultPath": "$.ExpiryDate"
                        },
                        "Check Dates": {
                          "Type": "Choice",
                          "Choices": [
                            {
                              "And": [
                                {
                                  "Variable": "$.ExpiryDate",
                                  "TimestampLessThanEqualsPath": "$$.Execution.StartTime"
                                },
                                {
                                  "Variable": "$.Status",
                                  "StringEquals": "Active"
                                }
                              ],
                              "Next": "UpdateAccessKey"
                            }
                          ],
                          "Default": "Check Dates finish"
                        },
                        "UpdateAccessKey": {
                          "Type": "Task",
                          "End": true,
                          "Parameters": {
                            "AccessKeyId.$": "$.AccessKeyId",
                            "UserName.$": "$.UserName",
                            "Status": "Inactive"
                          },
                          "Resource": "arn:aws:states:::aws-sdk:iam:updateAccessKey",
                          "ResultPath": null
                        },
                        "Check Dates finish": {
                          "Type": "Succeed"
                        }
                      }
                    }
                  }
                }
              },
              "ItemsPath": "$.Users",
              "ResultPath": null,
              "End": true
            }
          }
        }
      ],
      "End": true
    }
  }
}